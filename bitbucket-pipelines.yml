## Put content to S3 after each commit
pipelines:
  branches:
    main:
      - step:
          name: Deploy to S3
          deployment: test
          image: atlassian/pipelines-awscli
          script:
            - aws s3 sync --delete . s3://repo.uzeli.com/staging/activepieces/ --exclude ".git/*"
            - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 401309747089.dkr.ecr.us-east-1.amazonaws.com
            - docker build -t activepieces .
            - docker tag activepieces:latest 401309747089.dkr.ecr.us-east-1.amazonaws.com/activepieces:latest
            - docker push 401309747089.dkr.ecr.us-east-1.amazonaws.com/activepieces:latest

      - step:
          name: Deploy to Staging
          deployment: staging
          script:
            - echo "Deploying to Staging environment"
            - curl -sS -H "Content-Type:application/json" -X POST -d "{\"secret\":\"${DEPLOYMENT_APIKEY}\"}" ${DEPLOYMENT_ENDPOINT}/activepieces/deploy
